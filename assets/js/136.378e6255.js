(window.webpackJsonp=window.webpackJsonp||[]).push([[136],{1e3:function(t,a,s){"use strict";s.r(a);var n=s(27),e=Object(n.a)({},(function(){var t=this,a=t.$createElement,s=t._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h2",{attrs:{id:"_4-activemq消息高可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-activemq消息高可用"}},[t._v("#")]),t._v(" 4 ActiveMQ消息高可用")]),t._v(" "),s("h3",{attrs:{id:"_4-1-消息持久化"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-消息持久化"}},[t._v("#")]),t._v(" 4.1 消息持久化")]),t._v(" "),s("h4",{attrs:{id:"_4-1-1-持久化编码"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-1-持久化编码"}},[t._v("#")]),t._v(" 4.1.1 持久化编码")]),t._v(" "),s("p",[t._v("如果生产者把消息发送到了MQ消息服务，消费者还没有来得及消费，此时MQ服务停止或意外宕机，那么这些未被消费的消息改怎么处理呢？分为消息非持久化和消息持久化两种情况，"),s("strong",[t._v("消息非持久化")]),t._v("这些未被处理的消息直接丢失，"),s("strong",[t._v("消息持久化")]),t._v("会把这些未被消费的消息暂时存储起来，当MQ消息服务重新启动时恢复这些消息，消费者可以继续消费。")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("队列消息持久化")])])]),t._v(" "),s("p",[t._v("基于上面的示例代码，只需要为生产者客户端代码添加一行通过MessageProducer对象设置就可以了。（队列消息默认开启持久化这一行实际上可以省略）")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("producer"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setDeliveryMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("DeliveryMode")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("PERSISTENT"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br")])]),s("ul",[s("li",[s("strong",[t._v("主题消息持久化")])])]),t._v(" "),s("p",[t._v("主题消息默认不持久化，支持主题消息持久化，只需要修改消费者客户端代码如下：")]),t._v(" "),s("div",{staticClass:"language-java line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-java"}},[s("code",[t._v("    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n   connection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setClientID")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"client_0001"')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Topic")]),t._v(" topic "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createTopic")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("TOPIC_NAME"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("TopicSubscriber")]),t._v(" subscriber "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("  session"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("createDurableSubscriber")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("topic"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"remark..."')]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   connection"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("start")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n   subscriber"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("setMessageListener")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("message "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("->")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n           "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n   "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br"),s("span",{staticClass:"line-number"},[t._v("8")]),s("br"),s("span",{staticClass:"line-number"},[t._v("9")]),s("br")])]),s("p",[t._v("首先必须要通过"),s("code",[t._v('connection.setClientID("client_0001")')]),t._v("指定订阅者ID，因为如果不指定唯一ID,订阅者（非持久化订阅者）每次连接时都会随机创建一个ID，在消息持久化状态下，订阅者需要保证从离线到重新在线ClientID唯一不变，这样MQ消息服务才能确定主题消息是否被所有持久化订阅者消费了（如果MQ服务停止或宕机时，主题消息未被所有持久化订阅者消费的会被存储起来，已经被所有持久化订阅者消费的主题消息会直接丢弃）。")]),t._v(" "),s("p",[t._v("然后通过"),s("code",[t._v('session.createDurableSubscriber(topic, "remark...")')]),t._v("创建一个TopicSubscriber对象，告诉MQ服务其订阅的此主题消息要做持久化处理。")]),t._v(" "),s("h4",{attrs:{id:"_4-1-2-持久化存储机制"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-2-持久化存储机制"}},[t._v("#")]),t._v(" 4.1.2 持久化存储机制")]),t._v(" "),s("p",[t._v("ActiveMQ的消息持久化机制有JDBC、AMQ、KahaDB和LevelDB，无论使用哪种持久化方式，消息的存储逻辑都是一致的，就是在发送者将消息发送出去后，消息中心首先将消息存储到本地数据文件、内存数据库或者远程数据库等再试图将消息发送给接受者，成功则将消息从存储中删除，失败则继续尝试发送。MQ消息服务启动以后首先要检查指定的存储位置，如果有未发送成功的消息则需要把消息继续发送出去。下面分别介绍一下KahaDB与JDBC持久化机制。")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("KahaDB存储")])])]),t._v(" "),s("p",[t._v("KahaDB是一个基于文件的持久性数据库，消息存储使用一个事务日志和仅仅用一个索引文件来存储它所有的地址。KahaDB是目前默认的存储方式，可用于任何场景，提高了性能和恢复能力。在"),s("code",[t._v("activemq.xml")]),t._v("配置文件可查看其配置信息，更多的配置信息可参见官网 "),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=3MBuwq7D71NJpxmBqkqANw%3D%3D.RvHJu8TkCf7wtSTLi6endBC1PQdaaljKlKTCxfm6aSweo9sNPLvwP4dKgo0B220t",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://activemq.apache.org/ka..."),s("OutboundLink")],1)]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("persistenceAdapter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("kahaDB")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("directory")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("${activemq.data}/kahadb"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("persistenceAdapter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[s("code",[t._v("directory")]),t._v("这里指明了kahadb数据存储路径，默认为ActiveMQ安装目录下"),s("code",[t._v("/data/kahadb")]),t._v("，其中主要包含4类文件和一个lock：")]),t._v(" "),s("ol",[s("li",[s("strong",[t._v("db-"),s("number",[t._v(".log")])],1),t._v("：kahaDB存储消息到预定大小（默认32M）的数据记录文件中，文件命名为db-"),s("number",[t._v(".log，当数据文件已满时，一个新的文件会随之创建，number数值也会随之递增，当不再有引用到数据文件中的消息时，文件会被删除或者归档；")])],1),t._v(" "),s("li",[s("strong",[t._v("db.data")]),t._v("：改文件包含了持久化的BTree索引，它是消息的索引文件，使用BTree作为索引指向db-"),s("nubmer",[t._v(".log里面存储的消息；")])],1),t._v(" "),s("li",[s("strong",[t._v("db.free")]),t._v("：记录当前db.data文件里哪些页面是空闲的，文件具体内容是所有空闲页的ID;")]),t._v(" "),s("li",[s("strong",[t._v("db.redo")]),t._v("：用来进行消息恢复，如果KahaDB消息存储在强制退出后启动，用于恢复BTree索引；")]),t._v(" "),s("li",[s("strong",[t._v("lock")]),t._v("：文件锁，表示当前获得kahaDB读写权限的broker；")])]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("JDBC存储")])])]),t._v(" "),s("p",[t._v("如果采用JDBC机制存储，需要准备一个第三方数据库，这里以MySql数据库为例，更多信息参考"),s("a",{attrs:{href:"https://link.segmentfault.com/?enc=T%2Fy2UovLhflLGCnBCdy%2BIA%3D%3D.Lof8oDhsHSTQfrnYIHzXqgF3qbrrzZHJ740I8cia1hAdlN1CjKEb6ubAXCJY89O%2B",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://activemq.apache.org/jd..."),s("OutboundLink")],1)]),t._v(" "),s("p",[t._v("1.首先将mysql数据库的驱动包"),s("code",[t._v("mysql-connector-java-5.1.41.jar")]),t._v("添加到"),s("code",[t._v("ActiveMQ安装目录/lib")]),t._v("目录下，用于连接mysql数据库；")]),t._v(" "),s("p",[t._v("2.打开"),s("code",[t._v("activemq.xml")]),t._v("配置文件，找到"),s("code",[t._v("<beans>")]),t._v("节点添加数据库连接池配置信息"),s("code",[t._v("dataSource")]),t._v(" bean，")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("bean")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("id")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("mysql-ds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("class")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("org.apache.commons.dbcp2.BasicDataSource"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("destroy-method")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("close"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("property")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("driverClassName"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("com.mysql.jdbc.Driver"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("property")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("url"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("jdbc:mysql://localhost:3306/activemq?relaxAutoCommit=true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("property")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("username"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("root"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("property")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("password"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("123456"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("property")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("poolPreparedStatements"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("value")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("bean")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br"),s("span",{staticClass:"line-number"},[t._v("4")]),s("br"),s("span",{staticClass:"line-number"},[t._v("5")]),s("br"),s("span",{staticClass:"line-number"},[t._v("6")]),s("br"),s("span",{staticClass:"line-number"},[t._v("7")]),s("br")])]),s("p",[t._v("3."),s("code",[t._v("activemq.xml")]),t._v("配置文件中找到"),s("code",[t._v("<persistenceAdapter>")]),t._v("节点，修改为如下，")]),t._v(" "),s("div",{staticClass:"language-xml line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-xml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("persistenceAdapter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n    "),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("jdbcPersistenceAdapter")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("dataSource")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("#mysql-ds"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),t._v(" "),s("span",{pre:!0,attrs:{class:"token attr-name"}},[t._v("createTablesOnStartup")]),s("span",{pre:!0,attrs:{class:"token attr-value"}},[s("span",{pre:!0,attrs:{class:"token punctuation attr-equals"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')]),t._v("true"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v('"')])]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("/>")])]),t._v(" \n"),s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token tag"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("</")]),t._v("persistenceAdapter")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("p",[s("code",[t._v("mysql-ds")]),t._v("为上一步配置的beanId，"),s("code",[t._v("createTablesOnStartup")]),t._v("是否在启动的时候自动创建数据表，默认值是true，一般是第一次启动的时候设置为true之后再改为false。")]),t._v(" "),s("p",[t._v("上诉三步都配置完后，启动ActiveMQ服务会自动创建三张表，分别为"),s("code",[t._v("activemq_msgs")]),t._v("消息表，用于保存queue和topic消息， "),s("code",[t._v("activemq_acks")]),t._v("用于存储订阅关系，如果是持久化topic，订阅者和服务器的订阅关系在这个表保存，"),s("code",[t._v("activemq_lock")]),t._v("在集群环境中才有用，保证只有一个borker可以获取消息，用于记录哪个breker是当前的master broker。")]),t._v(" "),s("p",[t._v("JDBC每次消息过来都需要去写库和读库，ActiveMQ Journal使用高速缓存写入技术大大提高了性能，克服了JDBC Store的不足。当消费者的消费速度能够及时跟上生产者消息的生产速度时，journal文件能够大大减少需要写入到DB中的消息，比如生产者生产了1000条消息，这1000条消息会先保存到journal文件，如果消费者的消费速度很快的情况下，在journal文件还没有同步到DB之前，消费者已经消费了90%的消息，那么这个时候只需要同步剩余的10%的消息到DB。")]),t._v(" "),s("p",[t._v("使用高效的Journal，需要修改持久化配置，打开"),s("code",[t._v("activemq.xml")]),t._v("配置文件，找到"),s("code",[t._v("<persistenceAdapter>")]),t._v("节点，修改为如下：")]),t._v(" "),s("div",{staticClass:"language-abnf line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-abnf"}},[s("code",[s("span",{pre:!0,attrs:{class:"token rule"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("persistenceFactory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v("\n    <journalPersistenceAdapterFactory "),s("span",{pre:!0,attrs:{class:"token rule"}},[t._v("journalLogFiles")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"5"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token definition keyword"}},[t._v("dataDirectory")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"activemq-data"')]),t._v(" "),s("span",{pre:!0,attrs:{class:"token definition keyword"}},[t._v("dataSource")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"#mysql-ds"')]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("/")]),t._v("> \n"),s("span",{pre:!0,attrs:{class:"token rule"}},[s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("<")]),t._v("/persistenceFactory"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(">")])]),t._v(" \n")])]),t._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[t._v("1")]),s("br"),s("span",{staticClass:"line-number"},[t._v("2")]),s("br"),s("span",{staticClass:"line-number"},[t._v("3")]),s("br")])]),s("h3",{attrs:{id:"_4-2-事务"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-2-事务"}},[t._v("#")]),t._v(" 4.2 事务")]),t._v(" "),s("p",[t._v("在上面的示例代码中，创建session时传了两个参数，"),s("code",[t._v("createSession(false, Session.AUTO_ACKNOWLEDGE)")]),t._v("，第一个参数表示"),s("strong",[t._v("是否开启事务")]),t._v("，第二个参数表示"),s("strong",[t._v("签收方式")]),t._v("。")]),t._v(" "),s("p",[t._v("当开启事务，即第一个参数为"),s("code",[t._v("true")]),t._v("时，对于生产者而言执行"),s("code",[t._v("send()")]),t._v("方法后，消息不会直接进入消息队列中（没有真正发送到MQ服务），只有执行"),s("code",[t._v("session.commit()")]),t._v("消息才会真正发送成功进入消息队列中；对于消费者而言，消费完消息后，只有执行了"),s("code",[t._v("session.commit()")]),t._v("消息才会从消息队列中出队，如果不执行"),s("code",[t._v("session.commit()")]),t._v("会导致消息被重复消费。")]),t._v(" "),s("p",[t._v("事务开启的意义在于，对于多条必须同批次传输的消息，如果有一条传输失败，可以将事务回滚，再次传输，保证数据的完整性。")]),t._v(" "),s("h3",{attrs:{id:"_4-3-签收-ack"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#_4-3-签收-ack"}},[t._v("#")]),t._v(" 4.3 签收（ack）")]),t._v(" "),s("p",[t._v("签收和事务起到的作用是一样的，事务的优先级高于签收，即如果开启了事务，签收方式不管是哪种都是不起作用的，一般事务倾向于生产者使用，签收倾向于消费者使用。")]),t._v(" "),s("p",[t._v("签收方式总共有4种，"),s("code",[t._v("AUTO_ACKNOWLEDGE")]),t._v("自动签收，"),s("code",[t._v("CLIENT_ACKNOWLEDGE")]),t._v("手动签收，"),s("code",[t._v("DUPS_OK_ACKNOWLEDGE")]),t._v("可重复的签收（不常用），"),s("code",[t._v("SESSION_TRANSACTED")]),t._v("一般表示开启了事务设置任何签收方式是无效的。")]),t._v(" "),s("p",[t._v("如果签收方式为"),s("code",[t._v("CLIENT_ACKNOWLEDGE")]),t._v("手动签收，必须执行"),s("code",[t._v("message.acknowledge()")]),t._v("，消息才能被真正的消费或者发送。")])])}),[],!1,null,null,null);a.default=e.exports}}]);